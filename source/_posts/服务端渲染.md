
---
title: 服务端渲染
date: 2019-10-19 11:51:04
tags: [react, ssr, next]
categories: [学习]
---

服务端渲染

<!-- more -->
## 开始搭建项目webpack配置
```js
module.export = {
  target: 'node'
}
```
这个配置项，很有必要，如果是浏览器环境打包`require('path')`会把他打包到`build.js`中，如果是服务器环境就不会把他打包到`build.js`中
```js
const path = require('path')
module.export = {
  target: 'node',
  entry: './src/index.js',
  output: {
    filename: 'bundle.js',
    path: path.resolve(__dirname, 'build')
  }
}
```
`__dirname`指服务器根目录

## 同构
一套React代码，在服务端执行一次，再在客户端执行一次

普通用的是render，服务端渲染要用hydrate, 后续会讲
```js
ReactDom.hydrate(<Home/>, document.getElementById('root'))
```
## 访问静态资源
利用express的一个方法
```js
import express from 'express'
const app = express()
app.use(express.static('public'))
```
以后的静态资源都会去public里面找

## 遇到任何错误都可以在这个网站查找
[https://stackoverflow.com](https://stackoverflow.com/)

## 自动编译
webpack 的自动编译很简单 加一个配置项即可`--watch`
```js
webpack --config webpack.config.js --watch
```
node 就要借助nodemon 自动执行
```js
sudo npm i nodemon -g
```
package.json
```js
{
  "scripts": {
    //supervisor //也是一个第三方模块，和nodemon功能一样，但是写法不一样，下面的写法有误，不能这么用
    //"start": "nodemon build && node \"./build/bundle.js\"",
    "start": "nodemon --watch build --exec node \"./build/bundle.js\"",
  }
}
```
使用 `npm-run-all`
```js
{
"scripts": {
  "dev": "npm-run-all --parallel dev:**",
  "dev:start": "nodemon --watch build --exec node \"./build/bundle.js\"",
  "dev:build": "webpack --config webpack.server.js --watch"
  },
}
```

## webpack 自动化升级
[自动化升级](https://github.com/babel/babel-upgrade)
以后要用到`stage-x`提案阶段的东西就必须写入对应的功能名字，然后引入该插件，也可以用`npx babel-upgrade --write`自动升级，`packaage.json`就会自动安装该阶段的插件，自己选择使用哪个 `proposal` 特性的插件, 参考自 [一文读懂 babel7 的配置文件加载逻辑](https://segmentfault.com/a/1190000018358854)

> 注意升级前的写法必须是这样

```js
module.exports = {
  ...
  module: {
  rules: [{
    test: /\.js?$/,
    loader: 'babel-loader',
    exclude: /node_modules/,
    options: {
        presets: ['@babek/preset-stage-0'] // 这里可以是0-4
      }
    }]
  }
}
```
> 升级后遇到一个bug,就是引入插件会报错未找到，`npm i`之后就好了
新版的写法案例

```js
options: {
  presets: ['@babel/preset-react'], // 这不是必须的
  plugins: ['@babel/plugin-proposal-class-properties']
}
```
